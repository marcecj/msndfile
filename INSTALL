Installing msndfile
===================

There are two ways to compile msndfile.  The easy way is to call the m-file
`compile_msndfile.m` from Matlab.  There is also a more flexible build system
based on SCons available, that can also generate IDE project files (though right
now only for Microsoft Visual Studio).  For details on both methods, see their
relevant subsections.

Prerequisites
-------------

The basic dependencies of msndfile are:

- Matlab (tested with 2008a and 2010a Student Edition)
- http://www.mega-nerd.com/libsndfile[libsndfile]

To obtain libsndfile, you may try the following steps:

Linux::
    Install the libsndfile development package via your distributions package
    manager (typically a package with a '-devel' suffix).
Windows::
    Follow the instructions at http://www.mega-nerd.com/libsndfile[]).  After
    you have done that, copy the files `libsndfile-1.dll` and `libsndfile-1.lib`
    into the `Win` subdirectory (create it if it does not exist).
Mac OS X::
    Either download the sources from http://www.mega-nerd.com/libsndfile[] and
    compile them yourself or use a package management system like fink or
    macports or whatever system you already use.

If you are going to use the SCons based build system, you will also need

- http://www.python.org[Python] (whatever version SCons works with)
- http://scons.org[SCons] (tested with SCons 2.0.x)
- http://starship.python.net/crew/mhammond/win32/Downloads.html[Python Win32
  extensions] (optional, but necessary for some SCons features on Windows)
- the http://sconsmatlabtool.sf.net[Matlab SCons Tool]

The Matlab Tool is a submodule of this repository.  To install it, just run

-----------------------------
$ git submodule update --init
-----------------------------

If you want to build the documentation, you need to install
http://www.methods.co.nz/asciidoc/[AsciiDoc].

NOTE: I have never compiled msndfile under Mac OS X, if anybody succeeds in
doing so before I get around to it, I would like to know if it works.  I already
test compile with clang, so there *should* be no issues.

Using the compile_msndfile.m script
-----------------------------------

In Matlab, type `compile_msndfile` to compile all Mex extensions.

Using the SCons based build system
----------------------------------

The SCons based build system is in general more robust and flexibel than calling
Mex in compile_msndfile.m.  It uses an extension that properly presets a few
environment variables, though it slows compilation down the first time it is run
because it starts a Matlab subprocess to obtain them.

Anyway, to use SCons, call it from the command line like so:

--------------------------------------
$ scons [--interactive] [options] [target]
--------------------------------------

As to why I wrote a complicated SCons build system in the first place, well...
Apart from the usual features of real build systems (proper dependency tracking,
parallel builds, etc.) it can do the following things:

- create a Visual Studio solution file with Release and Debug Variants
- create a ZIP file for distribution
- separates release from debug builds
- *could* support cross-compiling to other architectures/operating systems to
  provide binaries for them
- builds the http://www.methods.co.nz/asciidoc/[AsciiDoc] documentation you are
  currently reading
- supports whatever compilers SCons (or third party extensions) supports, and
  not just what The Mathworks supports, which is incomplete and quite outdated
  anyway footnote:[Fun fact: the most recent minor version of GCC officially
  supported by The Mathworks for Matlab 2011a (GCC 4.3) is not even supported by
  the _compiler vendor_ anymore, though I admit this may be deliberate.].

For more information (such as available build targets and options), see the
output of `scons --help`.

If you need to work on the Code and plan to compile often, you can speed up the
process in general by using the interactive mode by passing the `--interactive`
option to SCons.  You can also override certain environment variables.

NOTE: To debug from within Visual Studio, you need to configure the project to
call MATLAB with the "-wait" argument.  I could not find a way to do this
automatically with SCons.

Linux
~~~~~

Just open a terminal and type

-----------------
    $ scons
-----------------

while in the source directory.  Users with 32 bit Matlab on 64 bit systems
should pass the option `--with-32bits` to enforce 32 bit compilation.

Windows
~~~~~~~

You can launch the batch file `start_scons.bat`, which launches scons and
defines an alias "scons" via doskey to simplify repeated compiling (i.e., just
type `scons` instead of `Full:\Path\To\scons`).  If scons is installed somewhere
else on your system, you need to alter the paths first.  Also, if SCons already
resides in your path, remove the line containing `doskey`.

Under Windows, the build system has an additional `vsproj` target.  This creates
a MS Visual Studio Solution file with msndfile as a project.  For other IDEs,
see http://www.scons.org/wiki/IDEIntegration[].

Mac OS X
~~~~~~~~

Follow the same steps as under Linux, or look into integrating SCons into your
IDE of choice (see http://www.scons.org/wiki/IDEIntegration[]).

Testing
-------

To run the test scripts, call `test_msndfile.m` from MATLAB.  This will test
`msndread` and `msndblockread`.  Performance tests are deactivated by default.
To run them, too, change `do_perf_tests` to `true` in `test_msndfile.m`.
